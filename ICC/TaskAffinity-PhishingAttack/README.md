# Summary
Task Affinity allows malicious activities to carry out phishing attacks

# Android versions affected
Tested on Android 4.2 - Android 7.1

# Description of vulnerability and corresponding exploit
When an activity is started, the android system looks for a task in which to launch the activity in. A task is a collection of activities. The task in which an activity is launched
depends on the launch mode of the activity. For illustration purposes, we will call an activity that is being launched the *callee activity* and an activity that launches a callee activity, *caller activity*.
The default behavior is to launch the callee activity in the same task as that of the caller activity. But a callee activity can ask the
android system to launch it in a different task. This can be done in one of three ways.

1.    The callee activity can specify a *task affinity* in the manifest file or
2.    The callee activity can specify launchMode=SingleTask in the manifest file or
3.    The caller activity can set the flag FLAG_ACTIVITY_NEW_TASK in the intent that is used to start the callee activity.

*Issue:* Since, the android system allows an activity to specify in which task it wants to get launched, a malicious app can specify in its manifest file that it wants to launch
a particular activity inside the malicious app in the same task as that of a benign activity. A malicious app can exploit this to poison any task and trigger phishing attacks.

*Example:* This vulnerability is demonstrated by the pair of benign and malicious apps in TaskAffinity-PhishingAttack/Benign and TaskAffinity-PhishingAttack/Malicious. The Benign app is as follows:

1.    User navigates to LoginActivity when she starts the app. In this activity the user is asked to enter her credentials.
2.    If the credentials are authorized the user navigates to HomeActivity where she can take a picture.
3.    She can click on the picture to start the ImageEditor Activity where she can edit the image and send it back to HomeActivity.
      Note that the ImageEditor has a task affinity="edu.ksu.santos.benign.editImage" which means that ImageEditor is started/launched in a new task called "edu.ksu.santos.benign.editImage".

The Malicious app has also managed to install itself in the device. Let us assume that the malicious app provides some useful functionality. The malicious app is as follows:

1.    MalActivity which provides useful functionality to the user but hides the malicious behavior.

Also, let us assume that the user while editing the image in the benign app remembered an important task which can be completed by the malicious app. Therefore, the user now navigates to the malicious app.
After a while let us assume that the user comes back to the benign app. The benign app will now display *HomeActivity* with the last edited image.
The user clicks on the image and is navigated to an activity in the malicious app i.e. MalActivity. MalActivity now displays a screen that looks like the Login screen of the
benign image editor app. The user enters her credentials and the credentials are saved by MalActivity. This happened because MalActivity had the same task affinity as the ImageEditor
and when MalActivity was started pushed on top of ImageEditor in the task "edu.ksu.santos.benign.editImage". When the user went back to HomeActivity and clicked on the image to edit
the image, the activity at the top of the task "edu.ksu.santos.benign.editImage" was started i.e. MalActivity.

# Steps to build the sample apps and re-produce the exploit

1. list targets:

    `$ android list targets`

2. list available Android Virtual Devices:

    `$ android list avd`

3.  create an emulator:

    `$ android create avd -n <name> -t <target>`

    *<target>* is obtained from the command listed in 1. *<name>* is the name you choose to give to the avd.

4.  start emulator:

    `$ emulator -avd <avd_name>`

    *<avd-name>* is obtained from the command listed in 2.

5. build and install *Benign*:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk. Build will fail without this.

    `$ ./gradlew installDebug`

6.  build and install *Malicious*:

    `$ cd Malicious`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk. Build will fail without this.

    `$ ./gradlew installDebug`

7.  Launch *Benign* in the emulator where it was installed. You will see a Login screen. Login with random strings. Click on the button to take a picture. Click on the displayed picture.

8. Launch *Malicious* in the same emulator.

9. Open *Benign* again from Home. You will see a button and the image that was last taken.

10. Click on the image, you will navigate to *Malicious* with a screen very similar to the login screen in *Benign*.

# References

1.  [Official Android Documentation](https://developer.android.com/guide/topics/manifest/activity-element.html#aff)

2.  [Towards Discovering and Understanding Task Hijacking in Android - Chuangang Ren](https://www.usenix.org/node/190944)

# Summary
Apps that do not validate requests to resources made from within a WebView, are vulnerable to loading malicious content in it.

# Android versions affected
Tested on Android 4.2 - Android 7.1

# Description of vulnerability and corresponding exploit
An Android app can display web pages by loading HTML/JavaScript files in a *WebView*. The loaded
HTML/JavaScript file runs in the context of the app i.e. it has access to the same resources and has the
same permissions the app has. If a user interactively requests a resource from within the WebView then
the app can choose to display the response in the WebView instead of a browser by using the WebViewClient
API. All responses to the WebView are routed through the WebViewClient. Android provides call back methods
in the WebViewClient through which one can check if the URL to which the request is being sent is valid.
One such method is *shouldOverrideUrlLoading()*.

*Issue:* *shouldOverrideUrlLoading()* takes an instance of WebView and the request as input and returns a
boolean. If true is returned then the host application handles the request else if false is returned then
the current WebView handles the request. If the method always returns false, then all URLs including malicious
ones can be loaded into the WebView.

*Example:* The vulnerability is demonstrated by *WebViewOverrideUrl-MITM/Benign*. The *MainActivity* of this app has a WebView which loads a *http* URL. The app contains *MyWebViewClient* which extends the default *WebClient* and
overrides the *shouldOverrideUrlLoading()* method. The method always returns false which means that any URL including malicious URLs can be loaded into the WebView. Since, the WebView loads content from a *http* url, it is possible for a man in the middle to embed malicious content into it. If the user interacts with the malicious content, for example she clicks on a button that triggers a request to a malicious URL, then the malicious URL will send a response and that response will be loaded into the WebView in the absence of sanity checks in the *shouldOverrideUrlLoading()* method.

Note that the default *shouldOverrideUrlLoading()* returns false all the time.  


# Steps to build the sample apps and re-produce the exploit

1.  Setup a local Web Server. We have used Flask here. If you want to use Flask follow the instructions [here](https://bitbucket.org/secure-it-i/android-vulnerabilities-benchmark/src/d932b692a7c5697d8b688e643d76b78e53126a60/LocalServer/README.md?at=master&fileviewer=file-view-default).

2. list targets:

    `$ android list targets`

3. list available Android Virtual Devices:

    `$ android list avd`

4.  create an emulator:

    `$ android create avd -n <name> -t <target>`

    *<target>* is obtained from the command listed in 1. *<name>* is the name you choose to give to the avd.

5.  start emulator:

    `$ emulator -avd <avd_name>`

    *<avd-name>* is obtained from the command listed in 3.

6.  edit the *url* field in *Benign/.../res/values/strings.xml* to reflect the url of the web server where   the html file being loaded is stored.

7. build and install *Benign*:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk. Build will fail without this.

    `$ ./gradlew installDebug`

8.  Set up Man-in-The-Middle and embed malicious code to invoke the *getKey()* method.

# References

1.  [Official Android Documentation](https://developer.android.com/reference/android/webkit/WebViewClient.html#shouldOverrideUrlLoading(android.webkit.WebView, android.webkit.WebResourceRequest))

2.  [Bifocals:Analyzing WebView Vulnerabilities in Android Applications - Erika Chin](https://people.eecs.berkeley.edu/~daw/papers/bifocals-wisa13.pdf)

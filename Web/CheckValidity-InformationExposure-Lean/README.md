# Summary
Apps that do not check for the validity of a Certificate when communicating with a server are
vulnerable to information exposure attacks.

# Android versions affected
Tested on Android 4.4 - Android 7.1

# Description of vulnerability and corresponding exploit
Android apps can use SSL/TLS to securely communicate with a web server. When an app wants to connect with
a web server, it requests the web server for a certificate signed by a certificate authority that the app trusts. Every certificate has a specified start date and end date. If the server the app is trying to connect to has a Certificate  with an end date earlier than the time when the app is trying to connect then the connection should be refused. Android provides *CheckValidity* API to check if the current date and time are within the validity period given in the certificate.


*Issue:* Apps can be vulnerable if they do not check the expire date of the certificate. A validity check can be implemented by the *CheckValidity* API which is a public method of *X509Certificate* interface. This validity check is performed on the elements of certificate chain in *checkServerTrusted()* of *X509Certificate* interface. If *CheckValidity* method is not used correctly then the app can end up connecting to a server signed by a Certificate that already expired.

*Example:* The vulnerability is demonstrated by *Benign*. The app connects to a server over SSL/TLS. The server is signed with a Certificate currently invalid and should refuse connection. However, the app successfully connects to this server as a result of the absence of implementation of the *CheckValidity* in *X509Certificate* interface.

# Steps to build the sample apps and to exploit the vulnerability

1. Setup a local Web Server with an expired certificate. We have used Flask here. If you want to use Flask follow the instructions [here](https://bitbucket.org/secure-it-i/android-app-vulnerability-benchmarks/src/76cc87180f064b328c37cc57b5c743dba378a5de/Misc/LocalServer/README.md?at=master&fileviewer=file-view-default).

2. List targets:

    `$ android list targets`

3. List available Android Virtual Devices:

    `$ android list avd`

4. Create an emulator:

    `$ android create avd -n <name> -t <target>`

    *<target>* is obtained from the command listed in 1. *<name>* is the name you choose to give to the avd.

5. Start emulator:

    `$ emulator -avd <avd_name>`

    *<avd-name>* is obtained from the command listed in 3.

6. Build and install *Benign*:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`

7. The web content displayed in the activity demonstrates that *Benign* does not verify the validity of the Certificate.

# References

1.  [Official Android Documentation](https://developer.android.com/reference/java/security/cert/X509Certificate.html#checkValidity())

2.  [Security Smells in Android](http://scg.unibe.ch/archive/papers/Ghaf17c.pdf)

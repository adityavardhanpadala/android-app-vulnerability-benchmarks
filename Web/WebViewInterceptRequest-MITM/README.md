# Summary
Apps that do not validate request URLs before loading them into a WebView are vulnerable to loading
malicious web content.

# Android versions affected
Tested on Android 4.4 - Android 7.1

# Description of vulnerability and corresponding exploit
An Android app can display web pages by loading HTML/JavaScript files in a *WebView*. The loaded
HTML/JavaScript file runs in the context of the app i.e. it has access to the same resources and has the
same permissions the app has. Therefore, it is vital to validate the URL being loaded especially if
the URL comes from user input or is read from a file accessible to other apps. Android provides
the *shouldInterceptRequest()* method in the *WebClient* API that can be used to intercept the
request from a WebView. This method is called every time the WebView requests to load some web content
in the WebView.

*Issue:* *shouldInterceptRequest()* takes an instance of WebView and the request as input and returns a
response. If the response returned is null then it just forwards the request to the URL in the request
and displays the response from the URL in the WebView. If this method returns null all the time then
any URL can be loaded into the WebView including malicious URLs. By default this method always returns null.
A correct implementation of this method should return null only for valid URLs.

*Example:* The vulnerability is demonstrated by *Benign*. The
*MainActivity* of this app has a WebView which loads a *http* URL provided by the user of the app which means that
the URL can be anything. The app contains *MyWebViewClient* which extends the default *WebClient* and
overrides the *shouldInterceptRequest()* method. The method just returns null which means that any URL including malicious URLs can be loaded into the WebView. Since, the WebView loads content from a *http* url, it is possible for a man in the middle to embed malicious content into it. If the user interacts with the malicious content, for example she clicks on a button that triggers a request to a malicious URL, then the malicious URL will send a response and that response will be loaded into the WebView in the absence of sanity checks in the *shouldInterceptRequest()* method.


# Steps to build the sample apps and to exploit the vulnerability

1. Setup a local Web Server. We have used Flask here. If you want to use Flask follow the instructions [here](https://bitbucket.org/secure-it-i/android-vulnerabilities-benchmark/src/d932b692a7c5697d8b688e643d76b78e53126a60/LocalServer/README.md?at=master&fileviewer=file-view-default).

2. List targets:

    `$ android list targets`

3. List available Android Virtual Devices:

    `$ android list avd`

4. Create an emulator:

    `$ android create avd -n <name> -t <target>`

    *<target>* is obtained from the command listed in 1. *<name>* is the name you choose to give to the avd.

5. Start emulator:

    `$ emulator -avd <avd_name>`

    *<avd-name>* is obtained from the command listed in 3.

6. Edit the *url* field in *Benign/.../res/values/strings.xml* to reflect the url of the web server where the html file being loaded is stored.

7. Build and install *Benign*:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`

8. Set up Man-in-The-Middle and embed malicious code to invoke the *getKey()* method.

# References

1.  [Official Android Documentation](https://developer.android.com/reference/android/webkit/WebViewClient.html#shouldInterceptRequest(android.webkit.WebView, android.webkit.WebResourceRequest))

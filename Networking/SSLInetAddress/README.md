# Summary
Apps that use the SSLCertificateSocketFactory.getSocket(InetAddress, ...) method are vulnerable to MITM attacks.   

# Android versions affected
Tested on Android 5.1.1 - Android 8.1

# Description of vulnerability and corresponding exploit
Android apps can use SSL/TLS for secure communication with a web server. Such communication involves two checks:

1. Check whether the web server is signed by a Certificate Authority that is trusted by the client, in this case the app.
2. After establishing the validity of the Certificate Authority, verify whether the certificate presented by the server is correct.  If it is not then the connection should be refused. Verification of the certificate can fail due two reasons:

    1. The certificate presented by the server does not have the correct hostname in its subject line.
    2. The server returns an incorrect certificate to the client due to virtual hosting.

The SSLCertificateSocketFactory class has methods to generate an object that can open SSL Sockets.  Use of SSLCertificateSocketFactory.getSocket with an InetAddress as the first parameter does not preform Hostname checks on the server. 
*Issue:*
Use of the method SSLCertificateSocketFactory.getSocket(InetAddress, ...) opens up a vulnerability to Man in the Middle attacks. 

*Example:*
This vulnerability is demonstrated by *Benign* app. *Benign* app uses `SSLSocket` and `SSLCertificateSocketFactory`, APIs that implement the SSL/TLS protocol, to connect to a server over an insecure network. Specifically, the app uses SSLCertificateSocketFactory.getSocket(InetAddress, ...) to access a SSLSocket that does not perform any SSL security checks when creating sockets. The local server in Misc/LocalServer acts as a man-in-the-middle and masquerades as the server. The app successfully connects to the man-in-the-middle since it allows connections to any host.

# Steps to build the sample apps and to exploit the vulnerability

1. Setup a local Web Server. We have used Flask here. If you want to use Flask follow the instructions [here](https://bitbucket.org/secure-it-i/android-app-vulnerability-benchmarks/src/master/Misc/LocalServer/).

2. List targets:

    `$ avdmanager list targets`

3. List available Android Virtual Devices:

    `$ avdmanager list avd`

4. Create an emulator:

    `$ avdmanager create avd -n <name> -k <target>`

    *<target>* is obtained from the command listed in 1. *<name>* is the name you choose to give to the avd.

5. Start emulator:

    `$ emulator -avd <avd_name>`

    *<avd-name>* is obtained from the command listed in 3.

6. Edit the *url* field in *Benign/.../res/values/strings.xml* to reflect the url of the web server where the html file being loaded is stored.

7. Build and install *Benign*:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installApi[VERSION]Debug`

8.  Check logcat to see response from local web server you setup:

    `$ adb logcat | grep "System.out"`

    The web content displayed in the console demonstrates that *Benign* does not verify the identity of the hostname it connects to and accepts connections from any server including malicious ones.

# References

1.  [Official Android Documentation](https://developer.android.com/training/articles/security-ssl.html)

2.  [Mitigating Android SSL Vulnerabilities - Vasant Sudhakar Tendulkar](https://repository.lib.ncsu.edu/bitstream/handle/1840.16/8840/etd.pdf?sequence=2&isAllowed=y)

3.  [MITRE Android Security Analysis Final Report] (https://www.mitre.org/sites/default/files/publications/pr-16-0202-android-security-analysis-final-report.pdf)

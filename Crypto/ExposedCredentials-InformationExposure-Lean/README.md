# Summary
Apps that store encryption keys in keystore without any protection parameter and save the keystore in the external storage are vulnerable to information exposure.

# Versions of Android affected
Tested on Android 4.4 - Android 7.1

# Description of the vulnerability and the corresponding exploit
Android apps can use keystore to store encryption keys and can save the keystore in the external storage. Keystore provides *setEntry* API to store a key entry. Along with the alias and the key, this *setEntry* API takes an instance of protection parameter as argument to protect the contents of the entry.

*Issue:* If the protection parameter argument in the *setEntry* API is set to *null*, then an attacker can get access to the entry and abuse it provided the name of the keystore file and the alias are exposed in the source code. This issue can be mitigated by using a password-based implementation of ProtectionParameter.

*Example:* This vulnerability is demonstrated by the pair of apps *Benign* and *Malicious*. *Benign* sets a secret key entry in the default keystore with a *null* protection parameter and stores the keystore in external file system. An attacker obtains the keystore file name and alias of the secret key from the code base and creates *Malicious* app that retrieves the *Benign's* key. 


# Steps to build the sample apps and to exploit the vulnerability

1. List targets:

    `$ avdmanager list targets`

2. List available Android Virtual Devices:

    `$ avdmanager list avd`

3. Create an emulator:

    `$ android create avd -n <name> -k <target>`

    *target* is obtained from the command listed in 1. *name* is the name you choose to give to the avd.

4. Start emulator:

    `$ emulator -avd <avd_name>`

    *avd-name* is obtained from the command listed in 2.

5. Build and install Benign:

    `$ cd Benign`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`

6. Build and install Malicious:

    `$ cd Malicious`

    Make sure there is a file called local.properties with an entry sdk=/path/to/Android/sdk.

    `$ ./gradlew installDebug`
    
8.  Launch *Benign* in the emulator where you installed the app.

8.  Launch *Malicious* in the emulator.

	You should see the message "Successfully retrieved the key.".

# References

1. [Security Smells in Android](http://scg.unibe.ch/archive/papers/Ghaf17c.pdf)

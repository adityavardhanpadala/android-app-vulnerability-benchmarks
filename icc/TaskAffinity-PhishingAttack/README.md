# Summary
Task Affinity allows malicious activities to carry out phishing attacks

# Android versions affected
Tested on Android 4.2 - Android 7.1

# Description of vulnerability and corresponding exploit
When an activity is started, the android system looks for a task in which to launch the activity in. A task is a collection of activities. The task in which an activity is launched
depends on the launch mode of the activity. For illustration purposes, we will call an activity that is being launched the *callee activity* and an activity that launches a callee activity, *caller activity*.
The default behavior is to launch the callee activity in the same task as that of the caller activity. But a callee activity can ask the
android system to launch it in a different task. This can be done in one of three ways.

1.    The callee activity can specify a *task affinity* in the manifest file or
2.    The callee activity can specify launchMode=SingleTask in the manifest file or
3.    The caller activity can set the flag FLAG_ACTIVITY_NEW_TASK in the intent that is used to start the callee activity.

*Issue:* Since, the android system allows an activity to specify in which task it wants to get launched, a malicious app can specify in its manifest file that it wants to launch
a particular activity inside the malicious app in the same task as that of a benign activity. A malicious app can exploit this to poison any task and trigger phishing attacks.

*Example:* This issue is best illustrated by the pair of benign and malicious apps in TaskAffinity-PhishingAttack/Benign and TaskAffinity-PhishingAttack/Malicious. The Benign app is as follows:

1.    User navigates to LoginActivity when she starts the app. In this activity the user is asked to enter her credentials.
2.    If the credentials are authorized the user navigates to HomeActivity where she can take a picture.
3.    She can click on the picture to start the ImageEditor Activity where she can edit the image and send it back to HomeActivity.
      Note that the ImageEditor has a task affinity="edu.ksu.santos.benign.editImage" which means that ImageEditor is started/launched in a new task called "edu.ksu.santos.benign.editImage".

The Malicious app has also managed to install itself in the device. Let us assume that the malicious app provides some useful functionality. The malicious app is as follows:

1.    MalActivity which provides useful functionality to the user but hides the malicious behavior.

Also, let us assume that the user while editing the image in the benign app remembered an important task which can be completed by the malicious app. Therefore, the user now navigates to the malicious app.
After a while let us assume that the user comes back to the benign app. The benign app will now display *HomeActivity* with the last edited image.
The user clicks on the image and is navigated to an activity in the malicious app i.e. MalActivity. MalActivity now displays a screen that looks like the Login screen of the
benign image editor app. The user enters her credentials and the credentials are saved by MalActivity. This happened because MalActivity had the same task affinity as the ImageEditor
and when MalActivity was started pushed on top of ImageEditor in the task "edu.ksu.santos.benign.editImage". When the user went back to HomeActivity and clicked on the image to edit
the image, the activity at the top of the task "edu.ksu.santos.benign.editImage" was started i.e. MalActivity.

# Steps to re-produce the exploit with Android Studio
1.    Go to open an existing project in Android Studio and browse to TaskAffinity-PhishingAttack/Benign
2.    If an emulator exists or a device is connected, launch Benign in it.
3.    If an emulator or device is not available then go to Run->Run App and click on "Create New Virtual Device".
4.    Follow the instructions to create an emulator and launch Benign in it.
5.    Again go to open existing project in Android Studio and browse to TaskAffinity-PhishingAttack/Malicious
6.    Launch Malicious in the same emulator/device that has Benign.
7.    Go to emulator/device.
8.    Start Benign -> Login -> Click on Take Picture -> Click on the image displayed.
9.    Start Malicious.
10.   Go back to Benign.
11.   Click on the image. You will see a screen similar to LoginActivity pop up but with the title Malicious1.

# Steps to re-produce the exploit automatically
Coming soon.
